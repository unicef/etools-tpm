<!--import [polymer, etools-ajax-sp, lodash]-->
<!--import [etools-app-config, last-created-behavior]-->

<dom-module id="update-vendor-data">
    <template>
        <etools-ajax-sp
                method="PATCH"
                url="{{url}}"
                body="{{postData}}"
                on-success="_handleResponse"
                on-fail="_handleError">
        </etools-ajax-sp>

        <etools-ajax-sp
                method="POST"
                url="{{activateUrl}}"
                body="{{activateData}}"
                on-success="_handleActivateResponse"
                on-fail="_handleActivateResponse">
        </etools-ajax-sp>
    </template>

    <script>
        Polymer({
            is: 'update-vendor-data',

            behaviors: [
                etoolsAppConfig.globals,
                TPMBehaviors.LastCreatedController,
                TPMBehaviors.StaticDataController,
            ],

            properties: {
                updateData: {
                    type: Object,
                    observer: '_vendorChanged'
                },
                vendor: {
                    type: Object,
                },
                vendorUpdating: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                errors: {
                    type: Object,
                    notify: true
                }
            },

            _vendorChanged: function(vendor) {
                if (!vendor || !this.vendor || !this.vendor.id) { return; }

                this.vendorUpdating = true;

                this.activateUrl = this.getEndpoint('partnerDetails', {id: this.vendor.id}).url + 'activate/';
                this.activateData = {};
            },

            _handleActivateResponse: function() {
                this.url = this.getEndpoint('partnerDetails', {id: this.vendor.id}).url;
                this.postData = _.cloneDeep(this.updateData);
            },

            _handleResponse: function(event, detail) {
                let partnerId = detail && detail.id;
                this._setLastData(detail, `partner_${partnerId}`);

                this.updateStaticData(detail);

                this.vendorUpdating = false;
                this.fire('vendor-updated', {success: true});
            },

            _handleError: function(event, error) {
                this.vendorUpdating = false;
                let responseData = error && error.request && error.request.detail &&
                        error.request.detail.request && error.request.detail.request.xhr;

                let {status, response} = responseData || {};
                if (typeof response === 'string') {
                    try {
                        response = JSON.parse(response);
                    } catch (e) {
                        response = {};
                    }
                }

                this.set('errors', response);
                this.fire('vendor-updated', {success: false});
            },

            updateStaticData: function(partner = {}) {
                let id = partner.id,
                    partners = this.getData('tpmPartners');

                if (!partners || !id) {
                    console.warn('Can not update partners static data. Id and partners must be defined');
                    return;
                }

                let index = _.findIndex(partners, partner => partner.id === id);

                if (~index) {
                    partners.splice(index, 1, partner);
                } else {
                    partners.push(partner);
                }

                this._updateData('tpmPartners', partners);
            }
        });
    </script>
</dom-module>
